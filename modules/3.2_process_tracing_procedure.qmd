---
title: "Process Tracing with a Causal Model"
subtitle: "Procedure"
format: 
   revealjs:
      embed-resources: true
      theme: serif
      slide-level: 3
      slide-number: true
      toc-depth: 2
      show-slide-number: all
      preview-links: auto
      number-sections: true
      link-color: orange
      smaller: true
---

```{r, include = FALSE}
set.seed(1)
library(knitr)
library(CausalQueries)
source("assets/setup.R")
knitr::opts_chunk$set(echo = TRUE)
```



## By hand: Procedure

1. Make a table with rows for all causal types (there may be many if you are doing by hand!!)
2. Add  a column to indicate your priors over these causal type
3. Add a column to say if the query is satisfied by the causal types
4. Calculate the conditional distributions given the types


## By hand: Example

Our DAG is:

$X \rightarrow M \rightarrow Y$

And we believe:

* $X=1$ for half the cases, randomly
* $X$ has a positive effect on $M$ for half the cases ("causes"), in the other half $M=0$ regardless of $X$
* $M$ has a positive effect on $Y$ for half the cases, in the other half $Y=0$ regardless of $M$


## By hand: Example {.smaller}

What are the types? How likely is each one? How likely is each given the data?

* Which ones satisfy the following query: $Y = 0$ *because* $X=0$?:
* Which ones are consistent with data: $X = 0, Y = 0$

| Type                                                     | X | M | Y | prob | Query? | Data ? |
|--------------------------------------------------------|---|---|---|------|--------|--------|
| X = 0, X causes M, M causes Y                             | 0 | 0 | 0 | 1/8  | ✓      | ✓      |
| X = 0, X causes M, M does not cause Y                     | 0 | 0 | 0 | 1/8  |        | ✓      |
| X = 0, X does not cause M, M causes Y                     | 0 | 0 | 0 | 1/8  |        | ✓      |
| X = 0, X does not cause M, M does not cause Y             | 0 | 0 | 0 | 1/8  |        | ✓      |
| X = 1, X causes M, M causes Y                             | 1 | 1 | 1 | 1/8  |        |        |
| X = 1, X causes M, M does not cause Y                     | 1 | 1 | 0 | 1/8  |        |        |
| X = 1, X does not cause M, M causes Y                     | 1 | 0 | 0 | 1/8  |        |        |
| X = 1, X does not cause M, M does not cause Y             | 1 | 0 | 0 | 1/8  |        |        |


## With CausalQueries: Step 1

Define a model

```{r, echo = TRUE}

model <- 
  make_model("X -> M -> Y") |>
  set_restrictions("M[X = 0] == 1") |>
  set_restrictions("Y[M = 0] == 1")

query <- "Y[X=1] > Y[X=0]"
```

## With CausalQueries: Step 2

Get types consistent with query

```{r}
get_query_types(model, query)

```

## With CausalQueries: Step 3


Get mapping from causal types to consistent data types

```{r}
inspect(model, what = "ambiguities_matrix") 
```

## With CausalQueries: Step 4

Get prior probabilities of each causal type

```{r}
CausalQueries:::get_type_prob(model)

```

## Put it all together

```{r}
model  |>
  grab(what = "ambiguities_matrix") |>
  data.frame() |>
  mutate(
    in_query = get_query_types(model, query)$types,
    priors   = CausalQueries:::get_type_prob(model)) |>
  kable()
```

## In one go with CausalQueries

```{r, echo = TRUE}
query_model(model, query, given = c("X==0 & M ==0 & Y == 0"))
```


Also try our [shiny app](https://shiny2.wzb.eu/ipi/process_tracing/)
